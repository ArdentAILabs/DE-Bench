-- cdc_pipeline_setup.sql - Snowflake setup for comprehensive CDC pipeline
-- Variables: {{DB}}, {{SCHEMA}}, {{WAREHOUSE}}, {{ROLE}}

USE ROLE {{ROLE}};
USE WAREHOUSE {{WAREHOUSE}};

-- Ensure we're using the correct database and schema
USE DATABASE {{DB}};
USE SCHEMA {{SCHEMA}};

-- ==================================================
-- SOURCE SYSTEM TABLES
-- ==================================================

-- CRM Customer data (source system 1)
CREATE OR REPLACE TABLE CRM_CUSTOMERS (
    CUSTOMER_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    CRM_ID VARCHAR(50) UNIQUE NOT NULL,
    FIRST_NAME VARCHAR(50) NOT NULL,
    LAST_NAME VARCHAR(50) NOT NULL,
    EMAIL VARCHAR(100) UNIQUE NOT NULL,
    PHONE VARCHAR(15),
    COMPANY_NAME VARCHAR(100),
    INDUSTRY VARCHAR(50),
    CUSTOMER_TIER VARCHAR(20) DEFAULT 'STANDARD',
    CREDIT_SCORE NUMBER,
    ANNUAL_REVENUE DECIMAL(15,2),
    STATUS VARCHAR(20) DEFAULT 'ACTIVE',
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    UPDATED_BY VARCHAR(100) DEFAULT USER
);

-- ERP Transaction data (source system 2)  
CREATE OR REPLACE TABLE ERP_TRANSACTIONS (
    TRANSACTION_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    ERP_TRANS_ID VARCHAR(50) UNIQUE NOT NULL,
    CUSTOMER_CRM_ID VARCHAR(50) NOT NULL,
    ACCOUNT_NUMBER VARCHAR(20) NOT NULL,
    TRANSACTION_TYPE VARCHAR(30) NOT NULL,
    AMOUNT DECIMAL(15,2) NOT NULL,
    CURRENCY VARCHAR(3) DEFAULT 'USD',
    TRANSACTION_DATE TIMESTAMP NOT NULL,
    DESCRIPTION VARCHAR(500),
    REFERENCE_NUMBER VARCHAR(100),
    STATUS VARCHAR(20) DEFAULT 'PENDING',
    PROCESSED_DATE TIMESTAMP,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    UPDATED_BY VARCHAR(100) DEFAULT USER
);

-- E-commerce Orders (source system 3)
CREATE OR REPLACE TABLE ECOMMERCE_ORDERS (
    ORDER_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    ORDER_NUMBER VARCHAR(50) UNIQUE NOT NULL,
    CUSTOMER_CRM_ID VARCHAR(50) NOT NULL,
    ORDER_DATE TIMESTAMP NOT NULL,
    TOTAL_AMOUNT DECIMAL(12,2) NOT NULL,
    TAX_AMOUNT DECIMAL(10,2) DEFAULT 0,
    SHIPPING_AMOUNT DECIMAL(10,2) DEFAULT 0,
    DISCOUNT_AMOUNT DECIMAL(10,2) DEFAULT 0,
    ORDER_STATUS VARCHAR(30) DEFAULT 'PENDING',
    PAYMENT_METHOD VARCHAR(30),
    SHIPPING_ADDRESS VARCHAR(1000),
    NOTES VARCHAR(2000),
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    UPDATED_BY VARCHAR(100) DEFAULT USER
);

-- Inventory Updates (source system 4)
CREATE OR REPLACE TABLE INVENTORY_UPDATES (
    UPDATE_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    PRODUCT_ID VARCHAR(50) NOT NULL,
    WAREHOUSE_ID VARCHAR(20) NOT NULL,
    UPDATE_TYPE VARCHAR(30) NOT NULL, -- RESTOCK, SALE, ADJUSTMENT, RETURN
    QUANTITY_CHANGE NUMBER NOT NULL,
    PREVIOUS_QUANTITY NUMBER NOT NULL,
    NEW_QUANTITY NUMBER NOT NULL,
    UNIT_COST DECIMAL(10,2),
    REASON_CODE VARCHAR(50),
    REFERENCE_ID VARCHAR(100), -- Order ID, Transfer ID, etc.
    UPDATE_DATE TIMESTAMP NOT NULL,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    UPDATED_BY VARCHAR(100) DEFAULT USER
);

-- ==================================================
-- TARGET TABLES (SYNCHRONIZED DATA)
-- ==================================================

-- Unified Customer Profile (target)
CREATE OR REPLACE TABLE UNIFIED_CUSTOMERS (
    UNIFIED_CUSTOMER_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    CRM_ID VARCHAR(50) UNIQUE NOT NULL,
    FIRST_NAME VARCHAR(50) NOT NULL,
    LAST_NAME VARCHAR(50) NOT NULL,
    EMAIL VARCHAR(100) UNIQUE NOT NULL,
    PHONE VARCHAR(15),
    COMPANY_NAME VARCHAR(100),
    INDUSTRY VARCHAR(50),
    CUSTOMER_TIER VARCHAR(20),
    CREDIT_SCORE NUMBER,
    ANNUAL_REVENUE DECIMAL(15,2),
    TOTAL_LIFETIME_VALUE DECIMAL(15,2) DEFAULT 0,
    TOTAL_ORDERS NUMBER DEFAULT 0,
    LAST_ORDER_DATE TIMESTAMP,
    LAST_TRANSACTION_DATE TIMESTAMP,
    STATUS VARCHAR(20) DEFAULT 'ACTIVE',
    DATA_SOURCE VARCHAR(50) DEFAULT 'CRM',
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    CDC_VERSION NUMBER DEFAULT 1,
    CDC_OPERATION VARCHAR(10),
    CDC_TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP()
);

-- Customer Transaction History (SCD Type 2)
CREATE OR REPLACE TABLE CUSTOMER_TRANSACTION_HISTORY (
    HISTORY_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    CUSTOMER_CRM_ID VARCHAR(50) NOT NULL,
    TRANSACTION_ID VARCHAR(50) NOT NULL,
    TRANSACTION_TYPE VARCHAR(30) NOT NULL,
    AMOUNT DECIMAL(15,2) NOT NULL,
    CURRENCY VARCHAR(3),
    TRANSACTION_DATE TIMESTAMP NOT NULL,
    ACCOUNT_NUMBER VARCHAR(20),
    STATUS VARCHAR(20),
    EFFECTIVE_DATE TIMESTAMP NOT NULL,
    EXPIRY_DATE TIMESTAMP DEFAULT '2999-12-31'::TIMESTAMP,
    IS_CURRENT BOOLEAN DEFAULT TRUE,
    CDC_OPERATION VARCHAR(10),
    CDC_TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    RECORD_HASH VARCHAR(64) -- For change detection
);

-- Inventory Snapshot (real-time stock levels)
CREATE OR REPLACE TABLE INVENTORY_SNAPSHOT (
    SNAPSHOT_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    PRODUCT_ID VARCHAR(50) NOT NULL,
    WAREHOUSE_ID VARCHAR(20) NOT NULL,
    CURRENT_QUANTITY NUMBER NOT NULL,
    RESERVED_QUANTITY NUMBER DEFAULT 0,
    AVAILABLE_QUANTITY NUMBER NOT NULL,
    LAST_RESTOCK_DATE TIMESTAMP,
    LAST_SALE_DATE TIMESTAMP,
    UNIT_COST DECIMAL(10,2),
    TOTAL_VALUE DECIMAL(15,2),
    STATUS VARCHAR(20) DEFAULT 'ACTIVE',
    CDC_VERSION NUMBER DEFAULT 1,
    CDC_TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    UNIQUE (PRODUCT_ID, WAREHOUSE_ID)
);

-- ==================================================
-- CDC MANAGEMENT TABLES
-- ==================================================

-- Stream Processing Log
CREATE OR REPLACE TABLE CDC_STREAM_LOG (
    LOG_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    STREAM_NAME VARCHAR(100) NOT NULL,
    TABLE_NAME VARCHAR(100) NOT NULL,
    PROCESSING_START TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    PROCESSING_END TIMESTAMP,
    RECORDS_PROCESSED NUMBER DEFAULT 0,
    INSERTS_COUNT NUMBER DEFAULT 0,
    UPDATES_COUNT NUMBER DEFAULT 0,
    DELETES_COUNT NUMBER DEFAULT 0,
    ERRORS_COUNT NUMBER DEFAULT 0,
    STATUS VARCHAR(20) DEFAULT 'RUNNING',
    ERROR_MESSAGE VARCHAR(2000),
    PROCESSED_BY VARCHAR(100) DEFAULT USER
);

-- Data Quality Violations
CREATE OR REPLACE TABLE CDC_DATA_QUALITY_LOG (
    VIOLATION_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    TABLE_NAME VARCHAR(100) NOT NULL,
    RECORD_ID VARCHAR(100),
    VIOLATION_TYPE VARCHAR(50) NOT NULL,
    VIOLATION_DESCRIPTION VARCHAR(1000) NOT NULL,
    RECORD_DATA VARIANT,
    SEVERITY VARCHAR(20) DEFAULT 'MEDIUM',
    STATUS VARCHAR(20) DEFAULT 'OPEN',
    DETECTED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    RESOLVED_DATE TIMESTAMP,
    RESOLVED_BY VARCHAR(100)
);

-- ==================================================
-- SAMPLE DATA
-- ==================================================

-- Insert sample CRM customers
INSERT INTO CRM_CUSTOMERS (CRM_ID, FIRST_NAME, LAST_NAME, EMAIL, PHONE, COMPANY_NAME, INDUSTRY, CUSTOMER_TIER, CREDIT_SCORE, ANNUAL_REVENUE)
VALUES 
('CRM001', 'John', 'Smith', 'john.smith@techcorp.com', '555-0101', 'TechCorp Inc', 'Technology', 'PREMIUM', 750, 250000.00),
('CRM002', 'Sarah', 'Johnson', 'sarah.johnson@retailco.com', '555-0102', 'RetailCo Ltd', 'Retail', 'STANDARD', 720, 150000.00),
('CRM003', 'Michael', 'Brown', 'michael.brown@finance.com', '555-0103', 'Finance Solutions', 'Finance', 'PREMIUM', 800, 500000.00),
('CRM004', 'Emma', 'Davis', 'emma.davis@healthcare.com', '555-0104', 'Healthcare Plus', 'Healthcare', 'ENTERPRISE', 780, 1000000.00),
('CRM005', 'James', 'Wilson', 'james.wilson@manufacturing.com', '555-0105', 'Manufacturing Co', 'Manufacturing', 'STANDARD', 700, 300000.00);

-- Insert sample ERP transactions
INSERT INTO ERP_TRANSACTIONS (ERP_TRANS_ID, CUSTOMER_CRM_ID, ACCOUNT_NUMBER, TRANSACTION_TYPE, AMOUNT, TRANSACTION_DATE, DESCRIPTION, STATUS)
VALUES 
('ERP001', 'CRM001', 'ACC-001', 'PAYMENT', 15000.00, '2024-01-15 10:30:00', 'Software license payment', 'COMPLETED'),
('ERP002', 'CRM002', 'ACC-002', 'INVOICE', 8500.00, '2024-01-16 14:20:00', 'Monthly service invoice', 'PENDING'),
('ERP003', 'CRM003', 'ACC-003', 'PAYMENT', 25000.00, '2024-01-17 09:15:00', 'Consulting services payment', 'COMPLETED'),
('ERP004', 'CRM004', 'ACC-004', 'REFUND', -2500.00, '2024-01-18 16:45:00', 'Service refund', 'PROCESSED'),
('ERP005', 'CRM005', 'ACC-005', 'PAYMENT', 12000.00, '2024-01-19 11:30:00', 'Equipment purchase', 'COMPLETED');

-- Insert sample e-commerce orders
INSERT INTO ECOMMERCE_ORDERS (ORDER_NUMBER, CUSTOMER_CRM_ID, ORDER_DATE, TOTAL_AMOUNT, TAX_AMOUNT, SHIPPING_AMOUNT, ORDER_STATUS, PAYMENT_METHOD)
VALUES 
('ORD2024001', 'CRM001', '2024-01-15 08:30:00', 1250.00, 100.00, 25.00, 'SHIPPED', 'CREDIT_CARD'),
('ORD2024002', 'CRM002', '2024-01-16 12:15:00', 890.50, 71.24, 15.99, 'PROCESSING', 'PAYPAL'),
('ORD2024003', 'CRM003', '2024-01-17 15:20:00', 2100.00, 168.00, 35.00, 'DELIVERED', 'BANK_TRANSFER'),
('ORD2024004', 'CRM004', '2024-01-18 09:45:00', 750.25, 60.02, 12.50, 'CANCELLED', 'CREDIT_CARD'),
('ORD2024005', 'CRM005', '2024-01-19 13:10:00', 1650.75, 132.06, 28.99, 'SHIPPED', 'CREDIT_CARD');

-- Insert sample inventory updates  
INSERT INTO INVENTORY_UPDATES (PRODUCT_ID, WAREHOUSE_ID, UPDATE_TYPE, QUANTITY_CHANGE, PREVIOUS_QUANTITY, NEW_QUANTITY, UNIT_COST, REASON_CODE, UPDATE_DATE)
VALUES 
('PROD001', 'WH01', 'SALE', -5, 100, 95, 25.00, 'ORDER_FULFILLMENT', '2024-01-15 10:00:00'),
('PROD002', 'WH01', 'RESTOCK', 50, 20, 70, 15.50, 'SUPPLIER_DELIVERY', '2024-01-16 08:30:00'),
('PROD003', 'WH02', 'ADJUSTMENT', -2, 35, 33, 45.00, 'DAMAGE_ADJUSTMENT', '2024-01-17 14:15:00'),
('PROD004', 'WH02', 'RETURN', 3, 12, 15, 80.00, 'CUSTOMER_RETURN', '2024-01-18 11:20:00'),
('PROD005', 'WH01', 'SALE', -10, 75, 65, 35.75, 'BULK_ORDER', '2024-01-19 16:30:00');

-- Initialize target tables with initial data sync
INSERT INTO UNIFIED_CUSTOMERS (CRM_ID, FIRST_NAME, LAST_NAME, EMAIL, PHONE, COMPANY_NAME, INDUSTRY, CUSTOMER_TIER, CREDIT_SCORE, ANNUAL_REVENUE, CDC_OPERATION)
SELECT CRM_ID, FIRST_NAME, LAST_NAME, EMAIL, PHONE, COMPANY_NAME, INDUSTRY, CUSTOMER_TIER, CREDIT_SCORE, ANNUAL_REVENUE, 'INITIAL_LOAD'
FROM CRM_CUSTOMERS;

INSERT INTO INVENTORY_SNAPSHOT (PRODUCT_ID, WAREHOUSE_ID, CURRENT_QUANTITY, AVAILABLE_QUANTITY, UNIT_COST, TOTAL_VALUE)
SELECT PRODUCT_ID, WAREHOUSE_ID, NEW_QUANTITY, NEW_QUANTITY, UNIT_COST, NEW_QUANTITY * UNIT_COST
FROM INVENTORY_UPDATES
WHERE UPDATE_ID IN (SELECT MAX(UPDATE_ID) FROM INVENTORY_UPDATES GROUP BY PRODUCT_ID, WAREHOUSE_ID);

-- Verify initial setup
SELECT 'CDC Pipeline setup complete - ready for streams and tasks' as STATUS;
SELECT 'CRM Customers:' as TABLE_INFO, COUNT(*) as RECORD_COUNT FROM CRM_CUSTOMERS;
SELECT 'ERP Transactions:' as TABLE_INFO, COUNT(*) as RECORD_COUNT FROM ERP_TRANSACTIONS;
SELECT 'E-commerce Orders:' as TABLE_INFO, COUNT(*) as RECORD_COUNT FROM ECOMMERCE_ORDERS;
SELECT 'Inventory Updates:' as TABLE_INFO, COUNT(*) as RECORD_COUNT FROM INVENTORY_UPDATES;
SELECT 'Unified Customers:' as TABLE_INFO, COUNT(*) as RECORD_COUNT FROM UNIFIED_CUSTOMERS;
